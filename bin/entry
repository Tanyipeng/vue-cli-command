#!/usr/bin/env node

const path = require('path');
const fs = require('fs');

// å¤„ç†æ ¸å¿ƒå‘½ä»¤è¡Œ
const program = require('commander');
// è¾“å‡ºéšæœºé¢œè‰²
const Printer = require('@darkobits/lolcatjs').default;
// shelljs
const shelljs = require('shelljs');
// æ”¹å˜å­—ä½“é¢œè‰²
const chalk = require('chalk');
// è·Ÿç”¨æˆ·è¿›è¡Œäº¤äº’
const inquirer = require('inquirer');
// loading
const ora = require('ora');
// ä¸‹è½½
const download = require('download-git-repo');
// è·å–è¿›ç¨‹ä½ç½®
const processPath = process.cwd();
// è·å–version
const input = fs.readFileSync(path.resolve(__dirname, './verson.txt'), 'utf8');
// ä¸‹è½½çš„url
const tmpUrl = 'direct:https://github.com/Tanyipeng/simple-vue-cli.git';

const binHandler = {
  init() {
    inquirer
      .prompt([{
        type: 'text',
        message: `è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°${chalk.gray('ï¼ˆvue-appï¼‰')}`,
        name: 'dirname'
      }])
      .then(answers => {
        const dirname = answers.dirname || 'vue-app';
        const spinner = ora('ğŸ‘¼ä¸‹è½½åˆå§‹åŒ–æ¨¡æ¿...');
        const projectPath = `${processPath}/${dirname}`;
        spinner.start();
        shelljs.cd(processPath);
        shelljs.rm('-rf', projectPath);
        shelljs.mkdir(dirname);
        download(tmpUrl, projectPath, {
          clone: true
        }, err => {
          spinner.stop();
          if (err) {
            console.log(chalk.redBright('å•Šå“¦ï¼Œä¸‹è½½å¤±è´¥å•¦ğŸ‚'));
            process.exit(1);
          } else {
            console.log(chalk.greenBright('ä¸‹è½½æˆåŠŸğŸƒ'));
            console.log(chalk.greenBright('cd'), chalk.greenBright(dirname));
            console.log(chalk.greenBright('npm install'), chalk.green('or'), chalk.greenBright('yarn'));
            console.log(chalk.greenBright('npm run dev'), chalk.green('or'), chalk.greenBright('yarn dev'));
            // ä¿®æ”¹nameä¸ºç”¨æˆ·çš„æ–‡ä»¶å¤¹åç§°
            shelljs.sed('-i', 'simple-vue-cli', dirname, `${projectPath}/package.json`);
            process.exit(0);
          }
        })
      })
  }
}

// program.version
program.version(Printer.fromString(input), '-v --version');
program
  .usage('[cmd] <options>')
  .arguments('<cmd> [env]')
  .action((cmd, otherParams) => {
    const handler = binHandler[cmd];
    if (handler == null) {
      console.log(`${chalk.yellowBright('éå¸¸é—æ†¾')} ã€${chalk.redBright(cmd)}ã€‘ ${chalk.yellowBright('è¯¥å‘½ä»¤æš‚æœªæä¾›ğŸ‘»')}`);
      process.exit(1);
    } else {
      handler();
    }
  })

// program.command('init', 'init this project');
program.parse(process.argv);
